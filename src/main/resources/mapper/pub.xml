<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.academy.mapper.PubMapper">

    <!-- 공지사항 목록 조회 -->
    <select id="selectPubList" parameterType="com.academy.gosi.service.PubVO" resultType="com.academy.gosi.service.PubVO">
        SELECT PUB_NO AS pubNo,
               PUB_TYPE AS pubType,
               CAT_CD AS catCd,
               TITLE AS title,
               WRITE_ID AS writeId,
               WRITE_NM AS writeNm,
               HIT_CNT AS hitCnt,
               NOTICE_YN AS noticeYn,
               USE_YN AS useYn,
               DATE_FORMAT(REG_DATE, '%Y-%m-%d') AS regDate,
               DATE_FORMAT(MOD_DATE, '%Y-%m-%d') AS modDate
          FROM TB_PUB
         WHERE 1=1
        <if test="searchPubType != null and searchPubType != ''">
           AND PUB_TYPE = #{searchPubType}
        </if>
        <if test="searchCatCd != null and searchCatCd != ''">
           AND CAT_CD = #{searchCatCd}
        </if>
        <if test="searchKeyword != null and searchKeyword != ''">
           AND (TITLE LIKE CONCAT('%', #{searchKeyword}, '%') OR CONTENT LIKE CONCAT('%', #{searchKeyword}, '%'))
        </if>
        <if test="searchTitle != null and searchTitle != ''">
           AND TITLE LIKE CONCAT('%', #{searchTitle}, '%')
        </if>
        <if test="searchWriteNm != null and searchWriteNm != ''">
           AND WRITE_NM LIKE CONCAT('%', #{searchWriteNm}, '%')
        </if>
        <if test="searchStartDate != null and searchStartDate != ''">
           AND REG_DATE &gt;= STR_TO_DATE(#{searchStartDate}, '%Y%m%d')
        </if>
        <if test="searchEndDate != null and searchEndDate != ''">
           AND REG_DATE &lt;= STR_TO_DATE(CONCAT(#{searchEndDate}, '235959'), '%Y%m%d%H%i%s')
        </if>
        <if test="searchNoticeYn != null and searchNoticeYn != ''">
           AND NOTICE_YN = #{searchNoticeYn}
        </if>
        <if test="searchUseYn != null and searchUseYn != ''">
           AND USE_YN = #{searchUseYn}
        </if>
         ORDER BY NOTICE_YN DESC, PUB_NO DESC
         LIMIT #{recordCountPerPage} OFFSET #{firstIndex}
    </select>

    <!-- 공지사항 목록 카운트 -->
    <select id="selectPubListCount" parameterType="com.academy.gosi.service.PubVO" resultType="int">
        SELECT COUNT(*)
          FROM TB_PUB
         WHERE 1=1
        <if test="searchPubType != null and searchPubType != ''">
           AND PUB_TYPE = #{searchPubType}
        </if>
        <if test="searchCatCd != null and searchCatCd != ''">
           AND CAT_CD = #{searchCatCd}
        </if>
        <if test="searchKeyword != null and searchKeyword != ''">
           AND (TITLE LIKE CONCAT('%', #{searchKeyword}, '%') OR CONTENT LIKE CONCAT('%', #{searchKeyword}, '%'))
        </if>
        <if test="searchTitle != null and searchTitle != ''">
           AND TITLE LIKE CONCAT('%', #{searchTitle}, '%')
        </if>
        <if test="searchWriteNm != null and searchWriteNm != ''">
           AND WRITE_NM LIKE CONCAT('%', #{searchWriteNm}, '%')
        </if>
        <if test="searchStartDate != null and searchStartDate != ''">
           AND REG_DATE &gt;= STR_TO_DATE(#{searchStartDate}, '%Y%m%d')
        </if>
        <if test="searchEndDate != null and searchEndDate != ''">
           AND REG_DATE &lt;= STR_TO_DATE(CONCAT(#{searchEndDate}, '235959'), '%Y%m%d%H%i%s')
        </if>
        <if test="searchNoticeYn != null and searchNoticeYn != ''">
           AND NOTICE_YN = #{searchNoticeYn}
        </if>
        <if test="searchUseYn != null and searchUseYn != ''">
           AND USE_YN = #{searchUseYn}
        </if>
    </select>

    <!-- 공지사항 상세 조회 -->
    <select id="selectPubDetail" parameterType="com.academy.gosi.service.PubVO" resultType="com.academy.gosi.service.PubVO">
        SELECT PUB_NO AS pubNo,
               PUB_TYPE AS pubType,
               CAT_CD AS catCd,
               TITLE AS title,
               CONTENT AS content,
               WRITE_ID AS writeId,
               WRITE_NM AS writeNm,
               HIT_CNT AS hitCnt,
               NOTICE_YN AS noticeYn,
               USE_YN AS useYn,
               DATE_FORMAT(REG_DATE, '%Y-%m-%d %H:%i:%s') AS regDate,
               DATE_FORMAT(MOD_DATE, '%Y-%m-%d %H:%i:%s') AS modDate
          FROM TB_PUB
         WHERE PUB_NO = #{pubNo}
    </select>

    <!-- 최대 공지사항 번호 조회 -->
    <select id="selectMaxPubNo" parameterType="com.academy.gosi.service.PubVO" resultType="int">
        SELECT IFNULL(MAX(PUB_NO), 0)
          FROM TB_PUB
         WHERE 1=1
        <if test="pubType != null and pubType != ''">
           AND PUB_TYPE = #{pubType}
        </if>
    </select>

    <!-- 공지사항 등록 -->
    <insert id="insertPub" parameterType="com.academy.gosi.service.PubVO" useGeneratedKeys="true" keyProperty="pubNo">
        INSERT INTO TB_PUB (
            PUB_TYPE, CAT_CD, TITLE, CONTENT,
            WRITE_ID, WRITE_NM, HIT_CNT, NOTICE_YN, USE_YN, REG_DATE
        ) VALUES (
            #{pubType}, #{catCd}, #{title}, #{content},
            #{writeId}, #{writeNm}, 0, IFNULL(#{noticeYn}, 'N'), IFNULL(#{useYn}, 'Y'), NOW()
        )
    </insert>

    <!-- 공지사항 수정 -->
    <update id="updatePub" parameterType="com.academy.gosi.service.PubVO">
        UPDATE TB_PUB
           SET TITLE = #{title},
               CONTENT = #{content},
               CAT_CD = #{catCd},
               NOTICE_YN = #{noticeYn},
               USE_YN = #{useYn},
               MOD_DATE = NOW()
         WHERE PUB_NO = #{pubNo}
    </update>

    <!-- 공지사항 삭제 -->
    <delete id="deletePub" parameterType="com.academy.gosi.service.PubVO">
        DELETE FROM TB_PUB WHERE PUB_NO = #{pubNo}
    </delete>

    <!-- 조회수 증가 -->
    <update id="updatePubHitCnt" parameterType="com.academy.gosi.service.PubVO">
        UPDATE TB_PUB
           SET HIT_CNT = HIT_CNT + 1
         WHERE PUB_NO = #{pubNo}
    </update>

    <!-- 첨부파일 목록 조회 -->
    <select id="selectPubFileList" parameterType="com.academy.gosi.service.PubVO" resultType="com.academy.gosi.service.PubVO">
        SELECT FILE_NO AS fileNo,
               PUB_NO AS pubNo,
               FILE_NAME AS fileName,
               FILE_PATH AS filePath,
               FILE_ORG_NM AS fileOrgNm,
               FILE_SIZE AS fileSize,
               FILE_EXT AS fileExt
          FROM TB_PUB_FILE
         WHERE PUB_NO = #{pubNo}
         ORDER BY FILE_NO
    </select>

    <!-- 첨부파일 등록 -->
    <insert id="insertPubFile" parameterType="com.academy.gosi.service.PubVO">
        INSERT INTO TB_PUB_FILE (
            PUB_NO, FILE_NAME, FILE_PATH, FILE_ORG_NM, FILE_SIZE, FILE_EXT
        ) VALUES (
            #{pubNo}, #{fileName}, #{filePath}, #{fileOrgNm}, #{fileSize}, #{fileExt}
        )
    </insert>

    <!-- 첨부파일 삭제 -->
    <delete id="deletePubFile" parameterType="com.academy.gosi.service.PubVO">
        DELETE FROM TB_PUB_FILE WHERE FILE_NO = #{fileNo}
    </delete>

    <!-- 공지사항별 첨부파일 전체 삭제 -->
    <delete id="deletePubFileByPubNo" parameterType="com.academy.gosi.service.PubVO">
        DELETE FROM TB_PUB_FILE WHERE PUB_NO = #{pubNo}
    </delete>

</mapper>
