<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.academy.mapper.MouiApplyMapper">

    <select id="selectMouiApplyList" parameterType="com.academy.mocktest.mouigosa.apply.service.MouiApplyVO" resultType="com.academy.mocktest.mouigosa.apply.service.MouiApplyVO">
        SELECT A.APPLY_SEQ AS applySeq, A.EXAM_SEQ AS examSeq, E.EXAM_NM AS examNm, E.EXAM_DATE AS examDate,
               A.USER_ID AS userId, A.USER_NM AS userNm, A.PHONE AS phone, A.APPLY_STATUS AS applyStatus,
               CASE A.APPLY_STATUS WHEN 'APPLY' THEN '신청' WHEN 'CANCEL' THEN '취소' WHEN 'ATTEND' THEN '응시' WHEN 'ABSENT' THEN '불참' ELSE A.APPLY_STATUS END AS applyStatusNm,
               A.SCORE AS score, A.RANKING AS ranking, A.PASS_YN AS passYn,
               DATE_FORMAT(A.APPLY_DATE, '%Y-%m-%d %H:%i') AS applyDate
          FROM TB_MOUI_APPLY A LEFT JOIN TB_MOUI_EXAM E ON A.EXAM_SEQ = E.EXAM_SEQ
         WHERE 1=1
        <if test="examSeq != 0">AND A.EXAM_SEQ = #{examSeq}</if>
        <if test="searchUserNm != null and searchUserNm != ''">AND A.USER_NM LIKE CONCAT('%', #{searchUserNm}, '%')</if>
        <if test="searchApplyStatus != null and searchApplyStatus != ''">AND A.APPLY_STATUS = #{searchApplyStatus}</if>
         ORDER BY A.APPLY_DATE DESC
         LIMIT #{recordCountPerPage} OFFSET #{firstIndex}
    </select>

    <select id="selectMouiApplyListCount" parameterType="com.academy.mocktest.mouigosa.apply.service.MouiApplyVO" resultType="int">
        SELECT COUNT(*) FROM TB_MOUI_APPLY A WHERE 1=1
        <if test="examSeq != 0">AND A.EXAM_SEQ = #{examSeq}</if>
        <if test="searchUserNm != null and searchUserNm != ''">AND A.USER_NM LIKE CONCAT('%', #{searchUserNm}, '%')</if>
        <if test="searchApplyStatus != null and searchApplyStatus != ''">AND A.APPLY_STATUS = #{searchApplyStatus}</if>
    </select>

    <select id="selectMouiApplyDetail" parameterType="com.academy.mocktest.mouigosa.apply.service.MouiApplyVO" resultType="com.academy.mocktest.mouigosa.apply.service.MouiApplyVO">
        SELECT APPLY_SEQ AS applySeq, EXAM_SEQ AS examSeq, USER_ID AS userId, USER_NM AS userNm,
               PHONE AS phone, EMAIL AS email, APPLY_STATUS AS applyStatus,
               DATE_FORMAT(APPLY_DATE, '%Y-%m-%d %H:%i:%s') AS applyDate,
               DATE_FORMAT(CANCEL_DATE, '%Y-%m-%d %H:%i:%s') AS cancelDate, CANCEL_REASON AS cancelReason,
               PAY_AMT AS payAmt, PAY_STATUS AS payStatus, DATE_FORMAT(PAY_DATE, '%Y-%m-%d') AS payDate,
               SCORE AS score, RANKING AS ranking, PASS_YN AS passYn,
               DATE_FORMAT(RESULT_DATE, '%Y-%m-%d') AS resultDate
          FROM TB_MOUI_APPLY WHERE APPLY_SEQ = #{applySeq}
    </select>

    <insert id="insertMouiApply" parameterType="com.academy.mocktest.mouigosa.apply.service.MouiApplyVO">
        INSERT INTO TB_MOUI_APPLY (EXAM_SEQ, USER_ID, USER_NM, PHONE, EMAIL, APPLY_STATUS, APPLY_DATE, PAY_AMT, REG_ID, REG_DATE)
        VALUES (#{examSeq}, #{userId}, #{userNm}, #{phone}, #{email}, 'APPLY', NOW(), #{payAmt}, #{regId}, NOW())
    </insert>

    <update id="updateMouiApply" parameterType="com.academy.mocktest.mouigosa.apply.service.MouiApplyVO">
        UPDATE TB_MOUI_APPLY SET USER_NM = #{userNm}, PHONE = #{phone}, EMAIL = #{email}, MOD_ID = #{modId}, MOD_DATE = NOW()
         WHERE APPLY_SEQ = #{applySeq}
    </update>

    <delete id="deleteMouiApply" parameterType="com.academy.mocktest.mouigosa.apply.service.MouiApplyVO">
        DELETE FROM TB_MOUI_APPLY WHERE APPLY_SEQ = #{applySeq}
    </delete>

    <update id="updateApplyStatus" parameterType="com.academy.mocktest.mouigosa.apply.service.MouiApplyVO">
        UPDATE TB_MOUI_APPLY SET APPLY_STATUS = #{applyStatus},
               CANCEL_DATE = CASE WHEN #{applyStatus} = 'CANCEL' THEN NOW() ELSE CANCEL_DATE END,
               CANCEL_REASON = #{cancelReason}, MOD_ID = #{modId}, MOD_DATE = NOW()
         WHERE APPLY_SEQ = #{applySeq}
    </update>

    <update id="updateExamResult" parameterType="com.academy.mocktest.mouigosa.apply.service.MouiApplyVO">
        UPDATE TB_MOUI_APPLY SET SCORE = #{score}, RANKING = #{ranking}, PASS_YN = #{passYn}, RESULT_DATE = NOW(), MOD_ID = #{modId}, MOD_DATE = NOW()
         WHERE APPLY_SEQ = #{applySeq}
    </update>

</mapper>
