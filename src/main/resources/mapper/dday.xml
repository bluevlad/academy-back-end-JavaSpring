<?xml version="1.0" encoding="UTF-8"?>
<!--
    수정일              수정자           수정내용
  ===========      =========    =================
 *2025.12.11       system       D-Day 관리 매퍼 신규 생성 (MySQL 버전)
-->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.academy.mapper.DdayMapper">

    <!-- 카테고리 목록 조회 -->
    <select id="selectCategoryList" parameterType="com.academy.dday.service.DdayVO" resultType="org.json.simple.JSONObject">
        SELECT CODE, NAME
        FROM TB_CATEGORY_INFO
        WHERE ISUSE = 'Y'
        <if test='menuType != null and menuType == "O"'>
            AND USE_ON = 'Y'
        </if>
        <if test='menuType != null and menuType == "F"'>
            AND USE_OFF = 'Y'
        </if>
        ORDER BY CODE
    </select>

    <!-- D-Day 목록 조회 -->
    <select id="selectDdayList" parameterType="com.academy.dday.service.DdayVO" resultType="org.json.simple.JSONObject">
        SELECT
            A.DDAY_IDX,
            A.USER_ID,
            A.DDAY_TYPE,
            (SELECT NAME FROM TB_CATEGORY_INFO WHERE CODE = A.DDAY_CATEGORY) AS DDAY_CATEGORY_NM,
            A.DDAY_CATEGORY,
            A.DDAY_NAME,
            DATE_FORMAT(STR_TO_DATE(A.DDAY_DATE, '%Y%m%d'), '%Y-%m-%d') AS DDAY_DATE,
            A.DDAY_LINK,
            A.DDAY_ACTIVE
        FROM TB_DDAY A
        INNER JOIN TB_CATEGORY_INFO B ON A.DDAY_CATEGORY = B.CODE
        WHERE 1=1
        <if test="searchDdayName != null and searchDdayName != ''">
            AND A.DDAY_NAME LIKE CONCAT('%', #{searchDdayName}, '%')
        </if>
        <if test="searchCategory != null and searchCategory != ''">
            AND B.CODE = #{searchCategory}
        </if>
        ORDER BY B.CODE, A.DDAY_IDX DESC
        LIMIT #{recordCountPerPage} OFFSET #{firstIndex}
    </select>

    <!-- D-Day 목록 건수 조회 -->
    <select id="selectDdayListCount" parameterType="com.academy.dday.service.DdayVO" resultType="int">
        SELECT COUNT(*) AS CNT
        FROM TB_DDAY A
        INNER JOIN TB_CATEGORY_INFO B ON A.DDAY_CATEGORY = B.CODE
        WHERE 1=1
        <if test="searchDdayName != null and searchDdayName != ''">
            AND A.DDAY_NAME LIKE CONCAT('%', #{searchDdayName}, '%')
        </if>
        <if test="searchCategory != null and searchCategory != ''">
            AND B.CODE = #{searchCategory}
        </if>
    </select>

    <!-- D-Day 상세 조회 -->
    <select id="selectDdayDetail" parameterType="com.academy.dday.service.DdayVO" resultType="org.json.simple.JSONObject">
        SELECT
            DDAY_IDX,
            USER_ID,
            DDAY_TYPE,
            DDAY_CATEGORY,
            DDAY_NAME,
            DDAY_DATE,
            DDAY_LINK,
            DDAY_ACTIVE
        FROM TB_DDAY
        WHERE DDAY_IDX = #{ddayIdx}
    </select>

    <!-- D-Day 등록 -->
    <insert id="insertDday" parameterType="com.academy.dday.service.DdayVO">
        INSERT INTO TB_DDAY (
            DDAY_IDX,
            USER_ID,
            DDAY_TYPE,
            DDAY_CATEGORY,
            DDAY_NAME,
            DDAY_DATE,
            REGDATE,
            DDAY_LINK,
            DDAY_ACTIVE
        ) VALUES (
            (SELECT IFNULL(MAX(DDAY_IDX), 0) + 1 FROM TB_DDAY AS T),
            #{userId},
            #{ddayType},
            #{ddayCategory},
            #{ddayName},
            #{ddayDate},
            now(),
            #{ddayLink},
            #{ddayActive}
        )
    </insert>

    <!-- D-Day 수정 -->
    <update id="updateDday" parameterType="com.academy.dday.service.DdayVO">
        UPDATE TB_DDAY
        SET
            DDAY_TYPE = #{ddayType},
            DDAY_CATEGORY = #{ddayCategory},
            DDAY_NAME = #{ddayName},
            DDAY_DATE = #{ddayDate},
            DDAY_LINK = #{ddayLink},
            DDAY_ACTIVE = #{ddayActive}
        WHERE DDAY_IDX = #{ddayIdx}
    </update>

    <!-- D-Day 삭제 -->
    <delete id="deleteDday" parameterType="com.academy.dday.service.DdayVO">
        DELETE FROM TB_DDAY
        WHERE DDAY_IDX = #{ddayIdx}
    </delete>

</mapper>
