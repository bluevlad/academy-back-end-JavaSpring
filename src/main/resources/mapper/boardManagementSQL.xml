<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.academy.mapper.BoardManagementMapper">

    <!-- 게시판 관리 목록 조회 -->
    <select id="selectBoardMngList" parameterType="com.academy.board.service.BoardMngVO" resultType="org.json.simple.JSONObject">
        SELECT
            BOARD_MNG_SEQ,
            BOARD_MNG_NAME,
            CASE ONOFF_DIV WHEN 'O' THEN '온라인' WHEN 'F' THEN '오프라인' WHEN 'T' THEN '강사용' ELSE ONOFF_DIV END AS ONOFF_DIV_NM,
            (SELECT CODE_NM FROM TB_BA_CONFIG_CD
             WHERE SYS_CD = 'BOARD_MNG_TYPE'
             AND CODE_VAL = A.BOARD_MNG_TYPE) AS BOARD_MNG_TYPE_NM,
            BOARD_MNG_TYPE,
            CASE OPEN_YN WHEN 'Y' THEN '로그인' WHEN 'N' THEN '비로그인' ELSE OPEN_YN END AS OPEN_YN_NM,
            CASE ISUSE WHEN 'Y' THEN '활성' WHEN 'N' THEN '비활성' ELSE ISUSE END AS ISUSE_NM,
            DATE_FORMAT(REG_DT, '%Y-%m-%d %H:%i:%s') AS REG_DT,
            REG_ID,
            DATE_FORMAT(UPD_DT, '%Y-%m-%d %H:%i:%s') AS UPD_DT,
            UPD_ID
        FROM TB_BOARD_MNG A
        WHERE 1=1
        <if test="searchKeyword != null and searchKeyword != ''">
            <choose>
                <when test='searchType == "BOARD_MNG_SEQ"'>
                    AND BOARD_MNG_SEQ LIKE CONCAT('%', #{searchKeyword}, '%')
                </when>
                <when test='searchType == "BOARD_MNG_NAME"'>
                    AND BOARD_MNG_NAME LIKE CONCAT('%', #{searchKeyword}, '%')
                </when>
                <otherwise>
                    AND (BOARD_MNG_SEQ LIKE CONCAT('%', #{searchKeyword}, '%')
                         OR BOARD_MNG_NAME LIKE CONCAT('%', #{searchKeyword}, '%'))
                </otherwise>
            </choose>
        </if>
        ORDER BY REG_DT DESC
        LIMIT #{recordCountPerPage} OFFSET #{firstIndex}
    </select>

    <!-- 게시판 관리 목록 건수 조회 -->
    <select id="selectBoardMngListCount" parameterType="com.academy.board.service.BoardMngVO" resultType="int">
        SELECT COUNT(*) AS CNT
        FROM TB_BOARD_MNG
        WHERE 1=1
        <if test="searchKeyword != null and searchKeyword != ''">
            <choose>
                <when test='searchType == "BOARD_MNG_SEQ"'>
                    AND BOARD_MNG_SEQ LIKE CONCAT('%', #{searchKeyword}, '%')
                </when>
                <when test='searchType == "BOARD_MNG_NAME"'>
                    AND BOARD_MNG_NAME LIKE CONCAT('%', #{searchKeyword}, '%')
                </when>
                <otherwise>
                    AND (BOARD_MNG_SEQ LIKE CONCAT('%', #{searchKeyword}, '%')
                         OR BOARD_MNG_NAME LIKE CONCAT('%', #{searchKeyword}, '%'))
                </otherwise>
            </choose>
        </if>
    </select>

    <!-- 게시판 타입 목록 조회 -->
    <select id="selectBoardTypeList" resultType="org.json.simple.JSONObject">
        SELECT CODE_CD, CODE_NM FROM TB_BA_CONFIG_CD WHERE SYS_CD = 'BOARD_MNG_TYPE'
    </select>

    <!-- 게시판 관리 상세 조회 -->
    <select id="selectBoardMngDetail" parameterType="com.academy.board.service.BoardMngVO" resultType="org.json.simple.JSONObject">
        SELECT
            BOARD_MNG_SEQ,
            (SELECT CODE_NM FROM TB_BA_CONFIG_CD
             WHERE SYS_CD = 'BOARD_MNG_TYPE'
             AND CODE_CD = A.BOARD_MNG_TYPE) AS BOARD_MNG_TYPE_NM,
            CASE ONOFF_DIV WHEN 'O' THEN '온라인' WHEN 'F' THEN '오프라인' WHEN 'T' THEN '강사용' ELSE ONOFF_DIV END AS ONOFF_DIV_NM,
            BOARD_MNG_NAME,
            BOARD_MNG_TYPE,
            ATTACH_FILE_YN,
            OPEN_YN,
            REPLY_YN,
            ISUSE,
            DATE_FORMAT(REG_DT, '%Y-%m-%d %H:%i:%s') AS REG_DT,
            REG_ID,
            DATE_FORMAT(UPD_DT, '%Y-%m-%d %H:%i:%s') AS UPD_DT,
            UPD_ID
        FROM TB_BOARD_MNG A
        WHERE BOARD_MNG_SEQ = #{boardMngSeq}
    </select>

    <!-- 게시판 관리 등록 -->
    <insert id="insertBoardMng" parameterType="com.academy.board.service.BoardMngVO">
        INSERT INTO TB_BOARD_MNG (
            BOARD_MNG_SEQ,
            BOARD_MNG_NAME,
            ONOFF_DIV,
            BOARD_MNG_TYPE,
            ATTACH_FILE_YN,
            OPEN_YN,
            REPLY_YN,
            ISUSE,
            REG_DT,
            REG_ID,
            UPD_DT,
            UPD_ID
        ) VALUES (
            (SELECT CONCAT(#{boardMngType}, '_', LPAD(IFNULL(CAST(SUBSTRING(MAX(BOARD_MNG_SEQ), -3) AS UNSIGNED) + 1, 1), 3, '0'))
             FROM TB_BOARD_MNG B
             WHERE BOARD_MNG_TYPE = #{boardMngType}),
            #{boardMngName},
            #{onoffDiv},
            #{boardMngType},
            'Y',
            #{openYn},
            <if test="boardMngType == 'BOARD' or boardMngType == 'TCC'">
                #{replyYn},
            </if>
            <if test="boardMngType != 'BOARD' and boardMngType != 'TCC'">
                'N',
            </if>
            #{isuse},
            now(),
            #{regId},
            now(),
            #{updId}
        )
    </insert>

    <!-- 게시판 관리 수정 -->
    <update id="updateBoardMng" parameterType="com.academy.board.service.BoardMngVO">
        UPDATE TB_BOARD_MNG
        SET
            BOARD_MNG_NAME = #{boardMngName},
            <if test="boardMngType == 'BOARD' or boardMngType == 'TCC'">
                REPLY_YN = #{replyYn},
            </if>
            OPEN_YN = #{openYn},
            ISUSE = #{isuse},
            UPD_DT = now(),
            UPD_ID = #{updId}
        WHERE BOARD_MNG_SEQ = #{boardMngSeq}
    </update>

    <!-- 게시판 관리 삭제 -->
    <delete id="deleteBoardMng" parameterType="com.academy.board.service.BoardMngVO">
        DELETE FROM TB_BOARD_MNG WHERE BOARD_MNG_SEQ = #{boardMngSeq}
    </delete>

    <!-- 게시판 관리 일괄 삭제 -->
    <delete id="deleteBoardMngBatch" parameterType="com.academy.board.service.BoardMngVO">
        DELETE FROM TB_BOARD_MNG WHERE BOARD_MNG_SEQ IN (${deleteIds})
    </delete>

    <!-- 게시판 종류 정보 조회 (게시물 등록 시) -->
    <select id="selectBoardKind" parameterType="com.academy.board.service.BoardVO" resultType="org.json.simple.JSONObject">
        SELECT
            BOARD_MNG_SEQ,
            BOARD_MNG_NAME,
            ONOFF_DIV,
            BOARD_MNG_TYPE,
            ATTACH_FILE_YN,
            OPEN_YN,
            REPLY_YN
        FROM TB_BOARD_MNG
        WHERE BOARD_MNG_SEQ = #{boardMngSeq}
    </select>

</mapper>
