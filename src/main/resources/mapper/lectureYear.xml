<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.academy.mapper.LectureYearMapper">

    <!-- 연도별 강의 목록 조회 -->
    <select id="selectLectureYearList" parameterType="com.academy.manage.lectureYear.service.LectureYearVO" resultType="com.academy.manage.lectureYear.service.LectureYearVO">
        SELECT A.YEAR_SEQ AS yearSeq,
               A.LECTURE_YEAR AS lectureYear,
               CONCAT(A.LECTURE_YEAR, '년도') AS yearNm,
               A.YEAR_DESC AS yearDesc,
               A.START_DATE AS startDate,
               A.END_DATE AS endDate,
               A.ISUSE AS isuse,
               A.STATUS AS status,
               CASE A.STATUS
                   WHEN 'OPEN' THEN '진행중'
                   WHEN 'CLOSE' THEN '종료'
                   WHEN 'READY' THEN '준비중'
                   ELSE A.STATUS
               END AS statusNm,
               (SELECT COUNT(*) FROM TB_LECTURE_YEAR_MAP WHERE LECTURE_YEAR = A.LECTURE_YEAR) AS lectureCnt,
               DATE_FORMAT(A.REG_DATE, '%Y-%m-%d %H:%i:%s') AS regDate
          FROM TB_LECTURE_YEAR A
         WHERE 1=1
        <if test="lectureYear != null and lectureYear != ''">
           AND A.LECTURE_YEAR = #{lectureYear}
        </if>
        <if test="searchStatus != null and searchStatus != ''">
           AND A.STATUS = #{searchStatus}
        </if>
        <if test="isuse != null and isuse != ''">
           AND A.ISUSE = #{isuse}
        </if>
         ORDER BY A.LECTURE_YEAR DESC
         LIMIT #{recordCountPerPage} OFFSET #{firstIndex}
    </select>

    <!-- 연도별 강의 목록 카운트 -->
    <select id="selectLectureYearListCount" parameterType="com.academy.manage.lectureYear.service.LectureYearVO" resultType="int">
        SELECT COUNT(*)
          FROM TB_LECTURE_YEAR A
         WHERE 1=1
        <if test="lectureYear != null and lectureYear != ''">
           AND A.LECTURE_YEAR = #{lectureYear}
        </if>
        <if test="searchStatus != null and searchStatus != ''">
           AND A.STATUS = #{searchStatus}
        </if>
        <if test="isuse != null and isuse != ''">
           AND A.ISUSE = #{isuse}
        </if>
    </select>

    <!-- 연도별 강의 상세 조회 -->
    <select id="selectLectureYearDetail" parameterType="com.academy.manage.lectureYear.service.LectureYearVO" resultType="com.academy.manage.lectureYear.service.LectureYearVO">
        SELECT A.YEAR_SEQ AS yearSeq,
               A.LECTURE_YEAR AS lectureYear,
               CONCAT(A.LECTURE_YEAR, '년도') AS yearNm,
               A.YEAR_DESC AS yearDesc,
               A.START_DATE AS startDate,
               A.END_DATE AS endDate,
               A.ISUSE AS isuse,
               A.STATUS AS status,
               CASE A.STATUS
                   WHEN 'OPEN' THEN '진행중'
                   WHEN 'CLOSE' THEN '종료'
                   WHEN 'READY' THEN '준비중'
                   ELSE A.STATUS
               END AS statusNm,
               A.REG_ID AS regId,
               DATE_FORMAT(A.REG_DATE, '%Y-%m-%d %H:%i:%s') AS regDate,
               A.MOD_ID AS modId,
               DATE_FORMAT(A.MOD_DATE, '%Y-%m-%d %H:%i:%s') AS modDate
          FROM TB_LECTURE_YEAR A
         WHERE A.YEAR_SEQ = #{yearSeq}
    </select>

    <!-- 연도 목록 조회 -->
    <select id="selectYearList" parameterType="com.academy.manage.lectureYear.service.LectureYearVO" resultType="com.academy.manage.lectureYear.service.LectureYearVO">
        SELECT LECTURE_YEAR AS lectureYear,
               CONCAT(LECTURE_YEAR, '년도') AS yearNm,
               STATUS AS status
          FROM TB_LECTURE_YEAR
         WHERE ISUSE = 'Y'
         ORDER BY LECTURE_YEAR DESC
    </select>

    <!-- 연도별 강의 통계 조회 -->
    <select id="selectLectureYearStats" parameterType="com.academy.manage.lectureYear.service.LectureYearVO" resultType="com.academy.manage.lectureYear.service.LectureYearVO">
        SELECT A.LECTURE_YEAR AS lectureYear,
               COUNT(DISTINCT M.LECCODE) AS lectureCnt,
               IFNULL(SUM(S.STUDENT_CNT), 0) AS studentCnt,
               IFNULL(SUM(S.COMPLETE_CNT), 0) AS completeCnt,
               CASE WHEN SUM(S.STUDENT_CNT) > 0
                    THEN ROUND(SUM(S.COMPLETE_CNT) * 100.0 / SUM(S.STUDENT_CNT), 2)
                    ELSE 0
               END AS completeRate,
               IFNULL(SUM(S.SALE_AMT), 0) AS saleAmt,
               IFNULL(SUM(S.REFUND_AMT), 0) AS refundAmt,
               IFNULL(SUM(S.SALE_AMT) - SUM(S.REFUND_AMT), 0) AS netSaleAmt
          FROM TB_LECTURE_YEAR A
          LEFT JOIN TB_LECTURE_YEAR_MAP M ON A.LECTURE_YEAR = M.LECTURE_YEAR
          LEFT JOIN TB_LECTURE_STATS S ON M.LECCODE = S.LECCODE
         WHERE A.LECTURE_YEAR = #{lectureYear}
         GROUP BY A.LECTURE_YEAR
    </select>

    <!-- 연도별 카테고리 강의 통계 조회 -->
    <select id="selectCategoryYearStatsList" parameterType="com.academy.manage.lectureYear.service.LectureYearVO" resultType="com.academy.manage.lectureYear.service.LectureYearVO">
        SELECT M.LECTURE_YEAR AS lectureYear,
               L.CATEGORY_CD AS categoryCd,
               C.CATEGORY_NM AS categoryNm,
               COUNT(DISTINCT M.LECCODE) AS lectureCnt,
               IFNULL(SUM(S.STUDENT_CNT), 0) AS studentCnt,
               IFNULL(SUM(S.SALE_AMT), 0) AS saleAmt
          FROM TB_LECTURE_YEAR_MAP M
          JOIN TB_LECTURE L ON M.LECCODE = L.LECCODE
          LEFT JOIN TB_CATEGORY C ON L.CATEGORY_CD = C.CATEGORY_CD
          LEFT JOIN TB_LECTURE_STATS S ON M.LECCODE = S.LECCODE
         WHERE M.LECTURE_YEAR = #{lectureYear}
         GROUP BY M.LECTURE_YEAR, L.CATEGORY_CD, C.CATEGORY_NM
         ORDER BY saleAmt DESC
    </select>

    <!-- 연도별 강사 강의 통계 조회 -->
    <select id="selectTeacherYearStatsList" parameterType="com.academy.manage.lectureYear.service.LectureYearVO" resultType="com.academy.manage.lectureYear.service.LectureYearVO">
        SELECT M.LECTURE_YEAR AS lectureYear,
               L.TEACHER_KEY AS teacherKey,
               T.TEACHER_NM AS teacherNm,
               COUNT(DISTINCT M.LECCODE) AS lectureCnt,
               IFNULL(SUM(S.STUDENT_CNT), 0) AS studentCnt,
               IFNULL(SUM(S.SALE_AMT), 0) AS saleAmt
          FROM TB_LECTURE_YEAR_MAP M
          JOIN TB_LECTURE L ON M.LECCODE = L.LECCODE
          LEFT JOIN TB_TEACHER T ON L.TEACHER_KEY = T.TEACHER_KEY
          LEFT JOIN TB_LECTURE_STATS S ON M.LECCODE = S.LECCODE
         WHERE M.LECTURE_YEAR = #{lectureYear}
         GROUP BY M.LECTURE_YEAR, L.TEACHER_KEY, T.TEACHER_NM
         ORDER BY saleAmt DESC
    </select>

    <!-- 연도별 매출 통계 조회 -->
    <select id="selectYearlySaleStatsList" parameterType="com.academy.manage.lectureYear.service.LectureYearVO" resultType="com.academy.manage.lectureYear.service.LectureYearVO">
        SELECT A.LECTURE_YEAR AS lectureYear,
               CONCAT(A.LECTURE_YEAR, '년도') AS yearNm,
               COUNT(DISTINCT M.LECCODE) AS lectureCnt,
               IFNULL(SUM(S.STUDENT_CNT), 0) AS studentCnt,
               IFNULL(SUM(S.SALE_AMT), 0) AS saleAmt,
               IFNULL(SUM(S.SALE_CNT), 0) AS saleCnt,
               IFNULL(SUM(S.REFUND_AMT), 0) AS refundAmt,
               IFNULL(SUM(S.REFUND_CNT), 0) AS refundCnt,
               IFNULL(SUM(S.SALE_AMT) - SUM(S.REFUND_AMT), 0) AS netSaleAmt
          FROM TB_LECTURE_YEAR A
          LEFT JOIN TB_LECTURE_YEAR_MAP M ON A.LECTURE_YEAR = M.LECTURE_YEAR
          LEFT JOIN TB_LECTURE_STATS S ON M.LECCODE = S.LECCODE
         WHERE A.ISUSE = 'Y'
         GROUP BY A.LECTURE_YEAR
         ORDER BY A.LECTURE_YEAR DESC
    </select>

    <!-- 연도 정보 등록 -->
    <insert id="insertLectureYear" parameterType="com.academy.manage.lectureYear.service.LectureYearVO">
        INSERT INTO TB_LECTURE_YEAR (
            LECTURE_YEAR, YEAR_DESC, START_DATE, END_DATE,
            ISUSE, STATUS, REG_ID, REG_DATE
        ) VALUES (
            #{lectureYear}, #{yearDesc}, #{startDate}, #{endDate},
            IFNULL(#{isuse}, 'Y'), IFNULL(#{status}, 'READY'), #{regId}, NOW()
        )
    </insert>

    <!-- 연도 정보 수정 -->
    <update id="updateLectureYear" parameterType="com.academy.manage.lectureYear.service.LectureYearVO">
        UPDATE TB_LECTURE_YEAR
           SET YEAR_DESC = #{yearDesc},
               START_DATE = #{startDate},
               END_DATE = #{endDate},
               ISUSE = #{isuse},
               STATUS = #{status},
               MOD_ID = #{modId},
               MOD_DATE = NOW()
         WHERE YEAR_SEQ = #{yearSeq}
    </update>

    <!-- 연도 정보 삭제 -->
    <delete id="deleteLectureYear" parameterType="com.academy.manage.lectureYear.service.LectureYearVO">
        DELETE FROM TB_LECTURE_YEAR WHERE YEAR_SEQ = #{yearSeq}
    </delete>

    <!-- 강의-연도 매핑 등록 -->
    <insert id="insertLectureYearMapping" parameterType="com.academy.manage.lectureYear.service.LectureYearVO">
        INSERT INTO TB_LECTURE_YEAR_MAP (
            LECTURE_YEAR, LECCODE, REG_ID, REG_DATE
        ) VALUES (
            #{lectureYear}, #{leccode}, #{regId}, NOW()
        )
    </insert>

    <!-- 강의-연도 매핑 삭제 -->
    <delete id="deleteLectureYearMapping" parameterType="com.academy.manage.lectureYear.service.LectureYearVO">
        DELETE FROM TB_LECTURE_YEAR_MAP
         WHERE LECTURE_YEAR = #{lectureYear}
           AND LECCODE = #{leccode}
    </delete>

</mapper>
